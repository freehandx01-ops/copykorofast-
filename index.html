<!doctype html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Niva Coin App</title>
  
  <!-- Scripts -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <!-- Firebase SDK (Compat Version) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <style type="text/tailwindcss">
    /* Base Styles */
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    
    /* Animation classes */
    .page { display: none; opacity: 0; transform: translateY(10px); transition: opacity 0.25s ease-out, transform 0.25s ease-out; }
    .page.active { display: block; opacity: 1; transform: translateY(0); }
    
    .nav-btn-internal { transition: transform 0.1s; }
    .nav-btn-internal:active { transform: scale(0.95); }

    /* Custom Input Styles to prevent zoom on focus */
    .form-input { font-size: 16px !important; }

    /* Loader */
    .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #00D27F; width: 32px; height: 32px; animation: spin 0.8s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.8); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(2px); }

    /* Theme Colors */
    /* Light Mode */
    html.light body { background-color: #f3f4f6; color: #111827; }
    html.light .bg-card { background-color: #ffffff; border: 1px solid #e5e7eb; }
    html.light .text-sec { color: #6b7280; }
    html.light .input-field { background-color: #f9fafb; border-color: #d1d5db; color: #111827; }
    html.light .bottom-nav { background-color: rgba(255,255,255,0.95); border-top: 1px solid #e5e7eb; }
    html.light .notice-box { background-color: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; }

    /* Dark Mode */
    html.dark body { background-color: #000000; color: #ffffff; }
    html.dark .bg-card { background-color: #111111; border: 1px solid #333333; }
    html.dark .text-sec { color: #9ca3af; }
    html.dark .input-field { background-color: #1f1f1f; border-color: #374151; color: #ffffff; }
    html.dark .bottom-nav { background-color: rgba(17,17,17,0.95); border-top: 1px solid #333333; }
    html.dark .notice-box { background-color: rgba(30, 58, 138, 0.2); border: 1px solid rgba(30, 58, 138, 0.5); color: #93c5fd; }

    /* Utilities */
    .coin-icon { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
    .payment-radio:checked + label { border-color: #00D27F; background-color: rgba(0, 210, 127, 0.1); }
  </style>
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { colors: { primary: '#00D27F' } } }
    }
  </script>
</head>
<body class="bg-gray-100 dark:bg-black text-gray-900 dark:text-white select-none">

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay hidden">
    <div class="loader"></div>
    <p id="loader-text" class="text-white mt-3 text-sm font-medium">Loading...</p>
  </div>

  <!-- Error Container -->
  <div id="error-container" class="hidden h-screen flex items-center justify-center p-6 text-center">
    <p class="text-red-500 font-bold">Error: App must be opened in Telegram.</p>
  </div>

  <!-- App Container -->
  <div id="app-container" class="relative min-h-screen pb-24 hidden">
    
    <!-- DASHBOARD PAGE -->
    <main id="page-dashboard" class="page active px-4 pt-4">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-sm font-semibold text-sec">Dashboard</h2>
          <h1 id="welcome-message" class="text-2xl font-bold">Welcome!</h1>
        </div>
        <img src="logo19.jpg" class="user-profile-pic w-12 h-12 rounded-full border-2 border-primary object-cover bg-gray-700" alt="Profile">
      </div>

      <!-- Coin Grid -->
      <div class="grid grid-cols-1 gap-3 mb-6">
        <button onclick="app.showPage('page-sell-niva')" class="nav-btn-internal w-full h-16 bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-xl flex items-center px-4 shadow-lg shadow-emerald-500/20 text-white">
          <img src="./niva.jpg" class="w-10 h-10 rounded-full border border-white/30 mr-4 bg-white" alt="Niva">
          <span class="font-bold text-lg">Sell Niva</span>
        </button>
        <button onclick="app.showPage('page-sell-ns')" class="nav-btn-internal w-full h-16 bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl flex items-center px-4 shadow-lg shadow-purple-500/20 text-white">
          <img src="./ns.jpg" class="w-10 h-10 rounded-full border border-white/30 mr-4 bg-white" alt="Ns">
          <span class="font-bold text-lg">Sell Ns Coin</span>
        </button>
        <button onclick="app.showPage('page-sell-fira')" class="nav-btn-internal w-full h-16 bg-gradient-to-r from-amber-500 to-amber-600 rounded-xl flex items-center px-4 shadow-lg shadow-amber-500/20 text-white">
          <img src="./fira.jpg" class="w-10 h-10 rounded-full border border-white/30 mr-4 bg-white" alt="Fira">
          <span class="font-bold text-lg">Sell Fira</span>
        </button>
        <button onclick="app.showPage('page-sell-top-coin')" class="nav-btn-internal w-full h-16 bg-gradient-to-r from-sky-500 to-sky-600 rounded-xl flex items-center px-4 shadow-lg shadow-sky-500/20 text-white">
          <img src="./top.jpg" class="w-10 h-10 rounded-full border border-white/30 mr-4 bg-white" alt="Top">
          <span class="font-bold text-lg">Sell Top Coin</span>
        </button>
      </div>

      <!-- Notices -->
      <div class="space-y-4">
        <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-700/50 p-4 rounded-xl">
          <h3 class="font-bold text-orange-700 dark:text-orange-400 mb-2 flex items-center gap-2"><span class="material-symbols-outlined">campaign</span> Notice</h3>
          <ul class="text-sm text-orange-800 dark:text-orange-200 list-disc list-inside space-y-1">
            <li>‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø ‡¶ö‡¶æ‡¶∞‡ßç‡¶ú 5/- ‡¶ï‡¶æ‡¶ü‡¶æ ‡¶π‡¶¨‡ßá</li>
            <li>‡¶¨‡¶°‡¶º ‡¶è‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶ï‡ßá ‡¶á‡¶®‡¶¨‡¶ï‡ßç‡¶∏ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®</li>
            <li>‡¶´‡ßá‡¶ï ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡¶ø‡¶∞‡¶§ ‡¶•‡¶æ‡¶ï‡ßÅ‡¶®</li>
          </ul>
        </div>

        <div class="notice-box p-4 rounded-xl">
          <h3 class="font-bold mb-1">How it works</h3>
          <p class="text-sm opacity-90">Submit a sell request. Admin will verify manually. Payment is made within 15 minutes.</p>
        </div>
      </div>
      
      <!-- Telegram Floating Button -->
      <a href="https://t.me/earno_vate_earn" target="_blank" class="fixed bottom-24 right-4 z-50 bg-blue-600 text-white p-3 rounded-full shadow-xl active:scale-90 transition-transform">
        <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24"><path d="M9.78 18.65l.28-4.23 7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3 3.64 12c-.88-.25-.89-1.37.2-1.64l16.43-6.2c.75-.28 1.45.27 1.23 1.22l-2.67 12.3c-.22.99-1.21 1.22-1.87.73l-4.11-3.4-1.98 1.9z"></path></svg>
      </a>
    </main>

    <!-- SELL PAGES (Generic Template Logic via JS) -->
    <!-- NIVA PAGE -->
    <main id="page-sell-niva" class="page px-4 pt-2">
      <div class="flex items-center mb-4">
        <button onclick="app.showPage('page-dashboard')" class="p-2 -ml-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800"><span class="material-symbols-outlined">arrow_back</span></button>
        <h1 class="flex-1 text-center font-bold text-lg">Sell Niva Coin</h1>
        <div class="w-10"></div>
      </div>
      <!-- Content Container (Hidden if System Off) -->
      <div class="system-content">
        <div onclick="app.copyId('niva')" class="bg-card p-4 rounded-xl mb-4 flex items-center justify-between active:scale-95 transition-transform">
            <div><p class="text-xs text-sec uppercase font-bold">Transfer To</p><p id="id-niva" class="text-xl font-mono font-bold text-primary mt-1">...</p></div>
            <span class="material-symbols-outlined text-sec">content_copy</span>
        </div>
        <div class="bg-card p-4 rounded-xl mb-6 text-center">
            <p class="text-xs text-sec uppercase font-bold mb-2">Current Rates</p>
            <div id="rates-niva" class="text-sm font-medium space-y-1">Loading...</div>
        </div>
        <form onsubmit="app.handleSell(event, 'niva')">
            <div class="mb-4"><label class="text-sm font-medium mb-1 block">Sender Name/ID</label><input name="sender" required class="w-full form-input input-field rounded-lg h-12 px-4" placeholder="Your game name"></div>
            <div class="mb-4"><label class="text-sm font-medium mb-1 block">Amount</label><input type="number" id="amt-niva" required class="w-full form-input input-field rounded-lg h-12 px-4" placeholder="Min 10000" oninput="app.calc('niva')"><p id="payout-niva" class="text-right text-xs mt-2 text-primary font-bold">~ ‡ß≥0.00</p></div>
            <div class="mb-4"><label class="text-sm font-medium mb-1 block">Proof</label><input type="file" name="proof" required class="w-full text-sm text-sec file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-primary file:text-white"></div>
            <div class="mb-6"><label class="text-sm font-medium mb-2 block">Payment</label>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div><input type="radio" name="method" value="Bkash" id="n-bk" class="hidden payment-radio" checked><label for="n-bk" class="block text-center border p-2 rounded-lg cursor-pointer bg-card font-bold text-sm">Bkash</label></div>
                    <div><input type="radio" name="method" value="Nagad" id="n-ng" class="hidden payment-radio"><label for="n-ng" class="block text-center border p-2 rounded-lg cursor-pointer bg-card font-bold text-sm">Nagad</label></div>
                </div>
                <input type="tel" name="number" required class="w-full form-input input-field rounded-lg h-12 px-4" placeholder="01XXXXXXXXX" maxlength="11">
            </div>
            <button type="submit" class="w-full bg-primary text-black font-bold py-3 rounded-xl">Submit Order</button>
        </form>
      </div>
      <div class="system-off hidden flex flex-col items-center justify-center py-20 text-center">
          <h2 class="text-xl font-bold mb-2">Unavailable</h2>
          <p class="text-sec text-sm">This coin service is currently paused.</p>
      </div>
    </main>

    <!-- NS PAGE -->
    <main id="page-sell-ns" class="page px-4 pt-2">
      <div class="flex items-center mb-4"><button onclick="app.showPage('page-dashboard')" class="p-2 -ml-2"><span class="material-symbols-outlined">arrow_back</span></button><h1 class="flex-1 text-center font-bold text-lg">Sell NS Coin</h1><div class="w-10"></div></div>
      <div class="system-content">
        <div onclick="app.copyId('ns')" class="bg-card p-4 rounded-xl mb-4 flex justify-between active:scale-95"><div><p class="text-xs text-sec font-bold">Transfer To</p><p id="id-ns" class="text-xl font-mono font-bold text-primary mt-1">...</p></div><span class="material-symbols-outlined text-sec">content_copy</span></div>
        <div class="bg-card p-4 rounded-xl mb-6 text-center"><p class="text-xs text-sec font-bold mb-2">Current Rates</p><div id="rates-ns" class="text-sm font-medium space-y-1">Loading...</div></div>
        <form onsubmit="app.handleSell(event, 'ns')">
            <div class="mb-4"><label class="text-sm font-medium block">Sender Name/ID</label><input name="sender" required class="w-full form-input input-field rounded-lg h-12 px-4"></div>
            <div class="mb-4"><label class="text-sm font-medium block">Amount</label><input type="number" id="amt-ns" required class="w-full form-input input-field rounded-lg h-12 px-4" oninput="app.calc('ns')"><p id="payout-ns" class="text-right text-xs mt-2 text-primary font-bold">~ ‡ß≥0.00</p></div>
            <div class="mb-4"><label class="text-sm font-medium block">Proof</label><input type="file" name="proof" required class="w-full text-sm text-sec file:py-2 file:px-4 file:rounded-full file:bg-primary file:text-black"></div>
            <div class="mb-6"><label class="text-sm font-medium block mb-2">Payment</label><div class="grid grid-cols-2 gap-3 mb-3"><div><input type="radio" name="method" value="Bkash" id="ns-bk" class="hidden payment-radio" checked><label for="ns-bk" class="block text-center border p-2 rounded-lg bg-card font-bold text-sm">Bkash</label></div><div><input type="radio" name="method" value="Nagad" id="ns-ng" class="hidden payment-radio"><label for="ns-ng" class="block text-center border p-2 rounded-lg bg-card font-bold text-sm">Nagad</label></div></div><input type="tel" name="number" required class="w-full form-input input-field rounded-lg h-12 px-4" placeholder="Number"></div>
            <button type="submit" class="w-full bg-primary text-black font-bold py-3 rounded-xl">Submit Order</button>
        </form>
      </div>
      <div class="system-off hidden text-center py-20"><h2 class="text-xl font-bold">Unavailable</h2></div>
    </main>

    <!-- FIRA PAGE -->
    <main id="page-sell-fira" class="page px-4 pt-2">
      <div class="flex items-center mb-4"><button onclick="app.showPage('page-dashboard')" class="p-2 -ml-2"><span class="material-symbols-outlined">arrow_back</span></button><h1 class="flex-1 text-center font-bold text-lg">Sell Fira Coin</h1><div class="w-10"></div></div>
      <div class="system-content">
        <div onclick="app.copyId('fira')" class="bg-card p-4 rounded-xl mb-4 flex justify-between active:scale-95"><div><p class="text-xs text-sec font-bold">Transfer To</p><p id="id-fira" class="text-xl font-mono font-bold text-primary mt-1">...</p></div><span class="material-symbols-outlined text-sec">content_copy</span></div>
        <div class="bg-card p-4 rounded-xl mb-6 text-center"><p class="text-xs text-sec font-bold mb-2">Current Rates</p><div id="rates-fira" class="text-sm font-medium space-y-1">Loading...</div></div>
        <form onsubmit="app.handleSell(event, 'fira')">
            <div class="mb-4"><label class="text-sm font-medium block">Amount</label><input type="number" id="amt-fira" required class="w-full form-input input-field rounded-lg h-12 px-4" oninput="app.calc('fira')"><p id="payout-fira" class="text-right text-xs mt-2 text-primary font-bold">~ ‡ß≥0.00</p></div>
            <div class="mb-4"><label class="text-sm font-medium block">Proof (Video)</label><input type="file" name="proof" required accept="video/*" class="w-full text-sm text-sec file:py-2 file:px-4 file:rounded-full file:bg-primary file:text-black"></div>
            <div class="mb-6"><label class="text-sm font-medium block mb-2">Payment</label><div class="grid grid-cols-2 gap-3 mb-3"><div><input type="radio" name="method" value="Bkash" id="f-bk" class="hidden payment-radio" checked><label for="f-bk" class="block text-center border p-2 rounded-lg bg-card font-bold text-sm">Bkash</label></div><div><input type="radio" name="method" value="Nagad" id="f-ng" class="hidden payment-radio"><label for="f-ng" class="block text-center border p-2 rounded-lg bg-card font-bold text-sm">Nagad</label></div></div><input type="tel" name="number" required class="w-full form-input input-field rounded-lg h-12 px-4" placeholder="Number"></div>
            <button type="submit" class="w-full bg-primary text-black font-bold py-3 rounded-xl">Submit Order</button>
        </form>
      </div>
      <div class="system-off hidden text-center py-20"><h2 class="text-xl font-bold">Unavailable</h2></div>
    </main>

    <!-- TOP COIN PAGE -->
    <main id="page-sell-top-coin" class="page px-4 pt-2">
      <div class="flex items-center mb-4"><button onclick="app.showPage('page-dashboard')" class="p-2 -ml-2"><span class="material-symbols-outlined">arrow_back</span></button><h1 class="flex-1 text-center font-bold text-lg">Sell Top Coin</h1><div class="w-10"></div></div>
      <div class="system-content">
        <div class="bg-card p-4 rounded-xl mb-6 text-center"><p class="text-xs text-sec font-bold mb-2">Current Rates</p><div id="rates-top-coin" class="text-sm font-medium space-y-1">Loading...</div></div>
        <form onsubmit="app.handleSell(event, 'top-coin')">
            <div class="mb-4"><label class="text-sm font-medium block">Amount</label><input type="number" id="amt-top-coin" required class="w-full form-input input-field rounded-lg h-12 px-4" oninput="app.calc('top-coin')"><p id="payout-top-coin" class="text-right text-xs mt-2 text-primary font-bold">~ ‡ß≥0.00</p></div>
            <div class="mb-4"><label class="text-sm font-medium block">Coupon Code</label><textarea name="coupon" required class="w-full form-input input-field rounded-lg p-4 h-24" placeholder="Paste coupon here"></textarea></div>
            <div class="mb-6"><label class="text-sm font-medium block mb-2">Payment</label><div class="grid grid-cols-2 gap-3 mb-3"><div><input type="radio" name="method" value="Bkash" id="t-bk" class="hidden payment-radio" checked><label for="t-bk" class="block text-center border p-2 rounded-lg bg-card font-bold text-sm">Bkash</label></div><div><input type="radio" name="method" value="Nagad" id="t-ng" class="hidden payment-radio"><label for="t-ng" class="block text-center border p-2 rounded-lg bg-card font-bold text-sm">Nagad</label></div></div><input type="tel" name="number" required class="w-full form-input input-field rounded-lg h-12 px-4" placeholder="Number"></div>
            <button type="submit" class="w-full bg-primary text-black font-bold py-3 rounded-xl">Submit Order</button>
        </form>
      </div>
      <div class="system-off hidden text-center py-20"><h2 class="text-xl font-bold">Unavailable</h2></div>
    </main>

    <!-- PROFILE PAGE -->
    <main id="page-profile" class="page px-4 pt-4">
        <h1 class="text-center font-bold text-xl mb-6">Settings</h1>
        
        <!-- Warning Notice -->
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700/50 p-4 rounded-xl mb-6 text-center">
            <span class="material-symbols-outlined text-3xl text-blue-500 mb-2">info</span>
            <p class="text-blue-700 dark:text-blue-300 font-medium text-sm mb-4">‡¶Ø‡ßá ‡¶ï‡ßã‡¶® ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡ßá ‡¶®‡¶ø‡¶®</p>
            <a href="https://t.me/earno_vate_earn" target="_blank" class="inline-flex items-center gap-2 bg-blue-600 text-white font-bold py-2 px-6 rounded-lg text-sm">
                <span>Join Channel</span>
            </a>
        </div>

        <!-- User Info -->
        <div class="bg-card p-4 rounded-xl flex items-center gap-4 mb-6">
            <img src="logo19.jpg" class="user-profile-pic w-14 h-14 rounded-full border-2 border-primary object-cover">
            <div class="overflow-hidden">
                <h3 id="profile-name" class="font-bold text-lg truncate">User</h3>
                <p id="profile-id" class="text-xs text-sec font-mono">ID: Loading</p>
            </div>
        </div>

        <!-- Settings List -->
        <div class="bg-card rounded-xl overflow-hidden mb-6">
            <div class="flex items-center justify-between p-4 border-b border-gray-100 dark:border-gray-800">
                <div class="flex items-center gap-3"><span class="material-symbols-outlined text-sec">dark_mode</span><span>Dark Mode</span></div>
                <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="theme-toggle" class="sr-only peer"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary dark:bg-gray-700"></div></label>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="admin-panel" class="hidden">
            <h3 class="font-bold text-sec text-xs uppercase mb-3 px-2">Admin Control</h3>
            <div class="bg-card p-4 rounded-xl space-y-4">
                <div class="flex justify-between items-center"><span class="font-bold">System Status</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="adm-sys-status" class="sr-only peer"><div class="w-9 h-5 bg-gray-500 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary"></div></label></div>
                <hr class="border-gray-700 opacity-20">
                
                <!-- Dynamic Rate Inputs for all coins -->
                <form onsubmit="app.saveSettings(event)" class="space-y-4">
                    <div id="admin-coin-settings"></div> <!-- Filled via JS -->
                    <button class="w-full bg-primary text-black font-bold py-3 rounded-lg">Save Changes</button>
                </form>
            </div>
        </div>
    </main>

    <!-- HISTORY PAGE -->
    <main id="page-history" class="page px-4 pt-4 pb-20">
        <h1 class="font-bold text-xl mb-6">History <span class="text-sm font-normal text-sec">(24h)</span></h1>
        <div id="history-list" class="space-y-3"></div>
    </main>

    <!-- Bottom Nav -->
    <nav class="bottom-nav fixed bottom-0 w-full h-20 grid grid-cols-3 backdrop-blur-md z-40">
        <button onclick="app.showPage('page-dashboard')" class="flex flex-col items-center justify-center text-sec hover:text-primary active:text-primary"><span class="material-symbols-outlined text-2xl mb-1">dashboard</span><span class="text-[10px] font-bold">Home</span></button>
        <button onclick="app.showPage('page-history')" class="flex flex-col items-center justify-center text-sec hover:text-primary active:text-primary"><span class="material-symbols-outlined text-2xl mb-1">history</span><span class="text-[10px] font-bold">History</span></button>
        <button onclick="app.showPage('page-profile')" class="flex flex-col items-center justify-center text-sec hover:text-primary active:text-primary"><span class="material-symbols-outlined text-2xl mb-1">settings</span><span class="text-[10px] font-bold">Settings</span></button>
    </nav>
  </div>

  <script>
    const app = {
        config: {
            adminId: '6703675335',
            botToken: '8523876681:AAHJ3AGjdB7KpiHvrjMvq3clD5csFrVlt24',
            channelId: '-1002536173839',
            firebase: { apiKey: "AIzaSyCAQtTRKgOizQjgqCbIZ_Z357LQD2Woee8", authDomain: "earnovate-bot.firebaseapp.com", databaseURL: "https://earnovate-bot-default-rtdb.firebaseio.com", projectId: "earnovate-bot", appId: "1:395184310691:web:9a0a2e5ad0e954b527b216" }
        },
        state: { user: null, rates: {}, settings: {} },
        
        init: async function() {
            try {
                // Firebase Init
                firebase.initializeApp(this.config.firebase);
                this.db = firebase.database();

                // Telegram Init
                if(window.Telegram && window.Telegram.WebApp) {
                    this.tg = window.Telegram.WebApp;
                    this.tg.expand();
                    this.state.user = this.tg.initDataUnsafe.user;
                }
                
                // Fallback for debugging outside TG
                if(!this.state.user) this.state.user = { id: 6703675335, first_name: 'Test', photo_url: 'logo19.jpg' }; 

                // UI Setup
                this.setupTheme();
                this.setupProfile();
                this.listenData();
                this.renderHistory();
                
                document.getElementById('app-container').classList.remove('hidden');
                this.showPage('page-dashboard');
                
            } catch (e) {
                document.getElementById('error-container').classList.remove('hidden');
                console.error(e);
            }
        },

        setupTheme: function() {
            const saved = localStorage.getItem('theme') || 'light';
            if(saved === 'dark') document.documentElement.classList.add('dark');
            const toggle = document.getElementById('theme-toggle');
            toggle.checked = saved === 'dark';
            toggle.addEventListener('change', e => {
                const mode = e.target.checked ? 'dark' : 'light';
                document.documentElement.className = mode;
                localStorage.setItem('theme', mode);
            });
        },

        setupProfile: function() {
            const u = this.state.user;
            document.querySelectorAll('.user-profile-pic').forEach(i => i.src = u.photo_url || 'logo19.jpg');
            document.getElementById('welcome-message').innerText = `Hi, ${u.first_name}!`;
            document.getElementById('profile-name').innerText = u.first_name;
            document.getElementById('profile-id').innerText = `ID: ${u.id}`;
            if(u.id.toString() === this.config.adminId) document.getElementById('admin-panel').classList.remove('hidden');
        },

        listenData: function() {
            // Rates Listener
            this.db.ref('rates').on('value', s => {
                let data = s.val() || {};
                
                // DATA REPAIR LOGIC: Ensure all coins have Tier structure
                ['niva', 'ns', 'fira', 'top-coin'].forEach(k => {
                    if (typeof data[k] !== 'object' || data[k] === null) {
                        const val = typeof data[k] === 'number' ? data[k] : 0;
                        data[k] = { tier1: val, tier2: val, tier3: val };
                    }
                });
                
                this.state.rates = data;
                this.updateRateUI();
                if(this.state.user.id.toString() === this.config.adminId) this.renderAdminInputs();
            });

            // Settings Listener
            this.db.ref('settings').on('value', s => {
                this.state.settings = s.val() || {};
                this.updateSystemStatus();
            });
        },

        updateRateUI: function() {
            const r = this.state.rates;
            // Helper to render tiers
            const renderTiers = (tiers) => `
                <div class="grid grid-cols-3 gap-1 text-[11px]">
                    <div class="bg-gray-100 dark:bg-gray-800 p-1 rounded">10k+<br><span class="text-primary text-sm font-bold">‡ß≥${tiers.tier1}</span></div>
                    <div class="bg-gray-100 dark:bg-gray-800 p-1 rounded">50k+<br><span class="text-primary text-sm font-bold">‡ß≥${tiers.tier2}</span></div>
                    <div class="bg-gray-100 dark:bg-gray-800 p-1 rounded">100k+<br><span class="text-primary text-sm font-bold">‡ß≥${tiers.tier3}</span></div>
                </div>`;

            if(document.getElementById('rates-niva')) {
                document.getElementById('rates-niva').innerHTML = renderTiers(r.niva);
                document.getElementById('id-niva').innerText = r.transferIds?.niva || '...';
            }
            if(document.getElementById('rates-ns')) {
                document.getElementById('rates-ns').innerHTML = renderTiers(r.ns);
                document.getElementById('id-ns').innerText = r.transferIds?.ns || '...';
            }
            if(document.getElementById('rates-fira')) {
                document.getElementById('rates-fira').innerHTML = renderTiers(r.fira);
                document.getElementById('id-fira').innerText = r.transferIds?.fira || '...';
            }
            if(document.getElementById('rates-top-coin')) {
                document.getElementById('rates-top-coin').innerHTML = renderTiers(r['top-coin']);
            }
        },

        updateSystemStatus: function() {
            const s = this.state.settings;
            // Admin Toggle
            if(document.getElementById('adm-sys-status')) document.getElementById('adm-sys-status').checked = s.systemStatus === 'on';
            
            // Coin Pages Status
            ['niva', 'ns', 'fira', 'top-coin'].forEach(c => {
                const page = document.getElementById(`page-sell-${c}`);
                if(!page) return;
                const isOn = s.coinSystemStatus?.[c] === 'on';
                const isAdmin = this.state.user.id.toString() === this.config.adminId;
                
                if(!isOn && !isAdmin) {
                    page.querySelector('.system-content').classList.add('hidden');
                    page.querySelector('.system-off').classList.remove('hidden');
                } else {
                    page.querySelector('.system-content').classList.remove('hidden');
                    page.querySelector('.system-off').classList.add('hidden');
                }
            });
        },

        calc: function(coin) {
            const input = document.getElementById(`amt-${coin}`);
            const disp = document.getElementById(`payout-${coin}`);
            const amount = parseFloat(input.value) || 0;
            const rates = this.state.rates[coin];
            
            let rate = rates.tier1;
            if (amount >= 100000) rate = rates.tier3;
            else if (amount >= 50000) rate = rates.tier2;

            const total = (amount / 1000 * rate).toFixed(2);
            disp.innerText = `~ ‡ß≥${total} (@${rate})`;
        },

        handleSell: async function(e, coin) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true; btn.innerText = 'Sending...';

            const form = new FormData(e.target);
            const amt = form.get('amt-niva') || form.get('amt-ns') || document.getElementById(`amt-${coin}`).value; // Fallback
            const method = form.get('method');
            const num = form.get('number');
            const proof = form.get('proof');
            
            // Calc final payout
            const rates = this.state.rates[coin];
            let rate = rates.tier1;
            if (amt >= 100000) rate = rates.tier3;
            else if (amt >= 50000) rate = rates.tier2;
            const payout = (amt / 1000 * rate).toFixed(2);

            let msg = `üõí *New Sell Order: ${coin.toUpperCase()}*\n`;
            msg += `üë§ User: ${this.state.user.first_name} (ID: \`${this.state.user.id}\`)\n`;
            msg += `üí∞ Amount: ${amt/1000}k\n`;
            msg += `üíµ Payout: ‡ß≥${payout} (Rate: ${rate})\n`;
            msg += `üí≥ ${method}: \`${num}\`\n`;
            
            if(form.get('sender')) msg += `üéÆ Sender: \`${form.get('sender')}\`\n`;
            if(form.get('coupon')) msg += `üéü Coupon: \`${form.get('coupon')}\`\n`;

            try {
                const fd = new FormData();
                fd.append('chat_id', this.config.channelId);
                fd.append('caption', msg);
                fd.append('parse_mode', 'Markdown');
                
                if(proof.size > 0) {
                    if(proof.type.includes('video')) fd.append('video', proof);
                    else fd.append('photo', proof);
                    await fetch(`https://api.telegram.org/bot${this.config.botToken}/send${proof.type.includes('video')?'Video':'Photo'}`, { method: 'POST', body: fd });
                } else {
                    fd.append('text', msg);
                    await fetch(`https://api.telegram.org/bot${this.config.botToken}/sendMessage`, { method: 'POST', body: fd });
                }

                this.saveLocalHistory({coin, amt, payout, time: Date.now()});
                this.tg.showAlert("Order Submitted Successfully!");
                e.target.reset();
                this.showPage('page-dashboard');

            } catch(err) {
                alert("Failed: " + err.message);
            }
            btn.disabled = false; btn.innerText = 'Submit Order';
        },

        renderAdminInputs: function() {
            const container = document.getElementById('admin-coin-settings');
            const r = this.state.rates;
            const s = this.state.settings;

            let html = '';
            ['niva', 'ns', 'fira', 'top-coin'].forEach(c => {
                const isOn = s.coinSystemStatus?.[c] === 'on';
                const id = r.transferIds?.[c] || '';
                const tiers = r[c] || {tier1:0, tier2:0, tier3:0};
                
                html += `
                <div class="border border-gray-600 p-3 rounded mb-2">
                    <div class="flex justify-between mb-2">
                        <span class="font-bold uppercase text-primary">${c}</span>
                        <input type="checkbox" name="status_${c}" ${isOn?'checked':''} class="accent-primary w-5 h-5">
                    </div>
                    ${c !== 'top-coin' ? `<input type="text" name="id_${c}" value="${id}" class="w-full bg-black border border-gray-600 rounded p-1 text-xs mb-2 text-white" placeholder="Transfer ID">` : ''}
                    <div class="grid grid-cols-3 gap-2">
                        <input type="number" step="any" name="t1_${c}" value="${tiers.tier1}" class="w-full bg-black border border-gray-600 rounded p-1 text-xs text-white" placeholder="Tier 1">
                        <input type="number" step="any" name="t2_${c}" value="${tiers.tier2}" class="w-full bg-black border border-gray-600 rounded p-1 text-xs text-white" placeholder="Tier 2">
                        <input type="number" step="any" name="t3_${c}" value="${tiers.tier3}" class="w-full bg-black border border-gray-600 rounded p-1 text-xs text-white" placeholder="Tier 3">
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        },

        saveSettings: async function(e) {
            e.preventDefault();
            const f = new FormData(e.target);
            
            const updates = {
                settings: {
                    systemStatus: document.getElementById('adm-sys-status').checked ? 'on' : 'off',
                    coinSystemStatus: {}
                },
                rates: { transferIds: {} }
            };

            ['niva', 'ns', 'fira', 'top-coin'].forEach(c => {
                updates.settings.coinSystemStatus[c] = f.get(`status_${c}`) ? 'on' : 'off';
                if(c !== 'top-coin') updates.rates.transferIds[c] = f.get(`id_${c}`);
                updates.rates[c] = {
                    tier1: parseFloat(f.get(`t1_${c}`)) || 0,
                    tier2: parseFloat(f.get(`t2_${c}`)) || 0,
                    tier3: parseFloat(f.get(`t3_${c}`)) || 0
                };
            });

            await this.db.ref('/').update(updates);
            this.tg.showAlert("Settings Saved!");
        },

        saveLocalHistory: function(item) {
            let h = JSON.parse(localStorage.getItem('history') || '[]');
            h.unshift(item);
            h = h.filter(x => Date.now() - x.time < 86400000); // 24h
            localStorage.setItem('history', JSON.stringify(h));
            this.renderHistory();
        },

        renderHistory: function() {
            const h = JSON.parse(localStorage.getItem('history') || '[]');
            const el = document.getElementById('history-list');
            if(h.length === 0) { el.innerHTML = '<p class="text-center text-sec text-sm py-4">No recent history</p>'; return; }
            el.innerHTML = h.map(i => `
                <div class="bg-card p-3 rounded-lg flex justify-between items-center">
                    <div><p class="font-bold uppercase text-xs">${i.coin}</p><p class="text-[10px] text-sec">${new Date(i.time).toLocaleTimeString()}</p></div>
                    <div class="text-right"><p class="font-bold text-sm">${i.amt/1000}k</p><p class="text-xs text-green-500">‡ß≥${i.payout}</p></div>
                </div>
            `).join('');
        },

        showPage: function(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo({top:0});
        },
        
        copyId: function(coin) {
            const txt = document.getElementById(`id-${coin}`).innerText;
            navigator.clipboard.writeText(txt);
            this.tg.showAlert("ID Copied");
        }
    };

    document.addEventListener('DOMContentLoaded', () => app.init());
  </script>
</body>
</html>
